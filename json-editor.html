<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON æ¸¸æˆåº“å¯è§†åŒ–ç¼–è¾‘å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-bg {background: rgba(0,0,0,.45);}
    .drag-handle {cursor: move;}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-2xl font-semibold">JSON æ¸¸æˆåº“å¯è§†åŒ–ç¼–è¾‘å™¨</h1>
      <span class="text-xs text-slate-500">(æ”¯æŒå¢åˆ æ”¹æŸ¥ Â· åŠ¨æ€å­—æ®µ Â· å¯¼å…¥/å¯¼å‡º)</span>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-2">
    <label class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 cursor-pointer">
      <input id="fileInput" type="file" accept="application/json" class="hidden" />
      <span class="text-sm">ğŸ“‚ å¯¼å…¥ JSON</span>
    </label>
    <button id="btnExport" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">ğŸ’¾ å¯¼å‡º JSON</button>
    <button id="btnAdd" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">â• æ–°å»ºæ¸¸æˆ</button>
    <button id="btnManageFields" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">ğŸ§© å­—æ®µç®¡ç†</button>
    <button id="btnReset" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">ğŸ—‘ æ¸…ç©ºå½“å‰ï¼ˆä»…æœ¬åœ°ï¼‰</button>

    <div class="ml-auto flex items-center gap-2">
      <input id="searchInput" type="search" placeholder="æœç´¢ï¼šåç§°/ç±»å‹/ä»»æ„å­—æ®µ" class="w-64 px-3 py-2 text-sm rounded-xl border bg-white" />
      <select id="pageSize" class="px-2 py-2 text-sm rounded-xl border bg-white">
        <option value="10">10/é¡µ</option>
        <option value="20">20/é¡µ</option>
        <option value="50">50/é¡µ</option>
        <option value="100">100/é¡µ</option>
      </select>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 pb-4">
    <div class="bg-white border rounded-2xl shadow-sm p-4 md:p-6 flex flex-col gap-4">
      <div>
        <h2 class="text-lg font-semibold">åˆé›†åŸºæœ¬ä¿¡æ¯</h2>
        <p class="text-sm text-slate-500">è¿™äº›å­—æ®µå°†ä½œä¸ºå¯¼å‡ºçš„ <code>title</code> ä¸ <code>subtitle</code> å‡ºç°åœ¨æ•°æ®æ–‡ä»¶çš„é¡¶å±‚ï¼Œä¾›å…¶ä»–é¡µé¢ä½¿ç”¨ã€‚</p>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <label class="flex flex-col gap-2 text-sm">
          <span class="font-medium text-slate-700">åˆé›†æ ‡é¢˜</span>
          <input id="metaTitle" type="text" placeholder="ä¾‹å¦‚ï¼šPop çƒ­é—¨é€Ÿç©" class="px-3 py-2 rounded-xl border bg-white focus:outline-none focus:ring focus:ring-indigo-200" />
        </label>
        <label class="flex flex-col gap-2 text-sm md:col-span-2">
          <span class="font-medium text-slate-700">å‰¯æ ‡é¢˜ / æè¿°</span>
          <textarea id="metaSubtitle" rows="2" placeholder="ç®€è¦è¯´æ˜åˆé›†äº®ç‚¹æˆ–æ•°æ®æ¥æº" class="px-3 py-2 rounded-xl border bg-white focus:outline-none focus:ring focus:ring-indigo-200"></textarea>
        </label>
      </div>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 pb-24">
    <div id="tableWrap" class="overflow-x-auto bg-white border rounded-2xl shadow-sm"></div>
    <div id="pager" class="mt-3 flex items-center justify-between text-sm text-slate-600"></div>
  </main>

  <script>
    const STORAGE_KEY = 'jsonGameLibraryState';
    const createId = () => (window.crypto && typeof window.crypto.randomUUID === 'function')
      ? window.crypto.randomUUID()
      : 'id-' + Math.random().toString(36).slice(2, 10);
    const defaultMeta = {
      title: 'Pop çƒ­é—¨é€Ÿç©',
      subtitle: 'æ¥è‡ªå…¨çƒä¼‘é—²ç«™ç‚¹çš„é«˜äººæ°”å°æ¸¸æˆï¼Œç‚¹å‡»ç¼©ç•¥å›¾å³å¯é©¬ä¸Šå¼€ç©ã€‚'
    };
    const defaultFields = [
      { key: 'title', label: 'æ¸¸æˆåç§°', required: true },
      { key: 'slug', label: 'å”¯ä¸€æ ‡è¯†', required: true },
      { key: 'url', label: 'è·³è½¬é“¾æ¥', required: true },
      { key: 'thumbnail', label: 'å°é¢å›¾è·¯å¾„', required: true },
      { key: 'category', label: 'åˆ†ç±»', required: false }
    ];

    const defaultRecords = [
      {
        title: 'Bubble Shooter Pop',
        slug: 'bubble-shooter-pop',
        url: 'https://www.crazygames.com/game/bubble-shooter-pop',
        thumbnail: 'img-portal/bubbleshooterpop.jpg',
        category: 'Puzzle'
      },
      {
        title: 'Emoji Match 3D',
        slug: 'emoji-match-3d',
        url: 'https://www.crazygames.com/game/emoji-match-3d',
        thumbnail: 'img-portal/emojimatch.jpeg',
        category: 'Brain'
      },
      {
        title: 'Match Find 3D',
        slug: 'match-find-3d',
        url: 'https://www.crazygames.com/game/match-find-3d',
        thumbnail: 'img-portal/matchfind3d.jpg',
        category: 'Puzzle'
      },
      {
        title: 'Farm Block Puzzle',
        slug: 'farm-block-puzzle',
        url: 'https://www.crazygames.com/game/farm-block-puzzle',
        thumbnail: 'img-portal/farmblockpuzzle.jpg',
        category: 'Casual'
      },
      {
        title: 'Block Puzzle 3D',
        slug: 'block-puzzle-3d',
        url: 'https://www.crazygames.com/game/block-puzzle-3d',
        thumbnail: 'img-portal/blockpuzzle3d.jpg',
        category: 'Puzzle'
      },
      {
        title: 'Block Dropping Merge',
        slug: 'block-dropping-merge',
        url: 'https://www.crazygames.com/game/blocks-merge-3d',
        thumbnail: 'img-portal/blockdroppingmerge.jpg',
        category: 'Hypercasual'
      },
      {
        title: 'Paper.io 2',
        slug: 'paper-io-2',
        url: 'https://paper-io.com/',
        thumbnail: 'img-portal/Paper.jpg',
        category: 'Arcade'
      },
      {
        title: 'Getting Over It',
        slug: 'getting-over-it',
        url: 'https://www.crazygames.com/game/getting-over-it',
        thumbnail: 'img-portal/gettingoverIt.jpeg',
        category: 'Action'
      },
      {
        title: 'Crazy Motorcycle',
        slug: 'crazy-motorcycle',
        url: 'https://www.crazygames.com/game/moto-maniac-3',
        thumbnail: 'img-portal/crazymotorcycle.jpg',
        category: 'Racing'
      },
      {
        title: 'Hawaii Match 5',
        slug: 'hawaii-match-5',
        url: 'https://www.crazygames.com/game/hawaii-match-3',
        thumbnail: 'img-portal/hawaiimatch5.jpg',
        category: 'Match'
      },
      {
        title: 'My Little City',
        slug: 'my-little-city',
        url: 'https://www.crazygames.com/game/my-little-city',
        thumbnail: 'img-portal/mylittlecity.jpg',
        category: 'Strategy'
      },
      {
        title: 'Parking Fury 3D: Night Thief',
        slug: 'parking-fury-3d-night-thief',
        url: 'https://www.crazygames.com/game/parking-fury-3d-night-thief',
        thumbnail: 'img-portal/parkingfury3dn.jpg',
        category: 'Driving'
      },
      {
        title: 'Sudoku Classic',
        slug: 'sudoku-classic',
        url: 'https://sudoku.com/',
        thumbnail: 'img-portal/suduku.png',
        category: 'Numbers'
      },
      {
        title: 'Fall Beans 2',
        slug: 'fall-beans-2',
        url: 'https://www.crazygames.com/game/fall-beans',
        thumbnail: 'img-portal/fallbean2.jpeg',
        category: 'Arcade'
      },
      {
        title: 'Magic Solitaire',
        slug: 'magic-solitaire',
        url: 'https://www.crazygames.com/game/magic-solitaire-world',
        thumbnail: 'img-portal/magicsolitaire.jpg',
        category: 'Card'
      },
      {
        title: 'High School Mean Girls 3',
        slug: 'high-school-mean-girls-3',
        url: 'https://www.girlsgogames.com/game/high-school-mean-girls-3',
        thumbnail: 'img-portal/highschoolmeangirls3.jpg',
        category: 'Girls'
      },
      {
        title: 'Vex 3',
        slug: 'vex-3',
        url: 'https://www.crazygames.com/game/vex-3',
        thumbnail: 'img-portal/vexx3m.jpg',
        category: 'Platform'
      }
    ];

    const sampleGames = defaultRecords.map((game) => ({ ...game, _id: createId() }));

    let state = loadState();
    let collectionMeta = state.meta;
    let fields = state.fields;
    let games = state.items;
    let currentPage = 1;
    let sortState = { key: null, direction: 'asc' };

    const tableWrap = document.getElementById('tableWrap');
    const pagerEl = document.getElementById('pager');
    const searchInput = document.getElementById('searchInput');
    const pageSizeSelect = document.getElementById('pageSize');
    const fileInput = document.getElementById('fileInput');
    const metaTitleInput = document.getElementById('metaTitle');
    const metaSubtitleInput = document.getElementById('metaSubtitle');

    render();

    document.getElementById('btnAdd').addEventListener('click', () => openGameModal());
    document.getElementById('btnManageFields').addEventListener('click', openFieldManager);
    document.getElementById('btnExport').addEventListener('click', exportJSON);
    document.getElementById('btnReset').addEventListener('click', resetState);
    searchInput.addEventListener('input', () => { currentPage = 1; render(); });
    pageSizeSelect.addEventListener('change', () => { currentPage = 1; render(); });
    fileInput.addEventListener('change', handleImport);
    if (metaTitleInput) {
      metaTitleInput.addEventListener('input', () => updateMeta('title', metaTitleInput.value));
      metaTitleInput.addEventListener('blur', () => syncMetaInputs());
    }
    if (metaSubtitleInput) {
      metaSubtitleInput.addEventListener('input', () => updateMeta('subtitle', metaSubtitleInput.value));
      metaSubtitleInput.addEventListener('blur', () => syncMetaInputs());
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          return {
            meta: normaliseMeta(extractMeta(parsed)),
            fields: normaliseFields(parsed.fields || defaultFields),
            items: ensureIds(parsed.items || parsed.games || [])
          };
        } catch (err) {
          console.warn('è§£ææœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®', err);
        }
      }
      return { meta: { ...defaultMeta }, fields: [...defaultFields], items: [...sampleGames] };
    }

    function extractMeta(source) {
      if (!source || typeof source !== 'object') return defaultMeta;
      if (source.meta && typeof source.meta === 'object') {
        return source.meta;
      }
      return {
        title: source.title,
        subtitle: source.subtitle
      };
    }

    function ensureIds(list) {
      return list.map(item => ({
        ...item,
        _id: item._id || createId()
      }));
    }

    function normaliseMeta(meta) {
      const title = typeof meta?.title === 'string' ? meta.title.trim() : '';
      const subtitle = typeof meta?.subtitle === 'string' ? meta.subtitle.trim() : '';
      return {
        title: title || defaultMeta.title,
        subtitle: subtitle || defaultMeta.subtitle
      };
    }

    function normaliseFields(list) {
      const valid = Array.isArray(list) && list.length
        ? list.map(f => ({
            key: String(f.key || '').trim(),
            label: String(f.label || f.key || '').trim() || 'æœªå‘½åå­—æ®µ',
            required: Boolean(f.required)
          })).filter(f => f.key)
        : [...defaultFields];
      const unique = [];
      const seen = new Set();
      valid.forEach(f => {
        if (!seen.has(f.key)) {
          unique.push(f);
          seen.add(f.key);
        }
      });
      return unique.length ? unique : [...defaultFields];
    }

    function saveState() {
      const plainGames = games.map(({ _id, ...rest }) => rest);
      const payload = {
        meta: { ...collectionMeta },
        title: collectionMeta.title,
        subtitle: collectionMeta.subtitle,
        fields,
        items: games,
        games: plainGames
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function render() {
      syncMetaInputs();
      renderTable();
      renderPager();
      saveState();
    }

    function syncMetaInputs() {
      if (metaTitleInput) {
        metaTitleInput.value = collectionMeta.title || '';
      }
      if (metaSubtitleInput) {
        metaSubtitleInput.value = collectionMeta.subtitle || '';
      }
    }

    function updateMeta(key, value) {
      const trimmed = typeof value === 'string' ? value.trim() : '';
      collectionMeta = normaliseMeta({ ...collectionMeta, [key]: trimmed });
      syncMetaInputs();
      saveState();
    }

    function getFilteredGames() {
      const keyword = searchInput.value.trim().toLowerCase();
      let filtered = games;
      if (keyword) {
        filtered = games.filter(game => fields.some(field => {
          const value = game[field.key];
          return value && String(value).toLowerCase().includes(keyword);
        }));
      }
      if (sortState.key) {
        const { key, direction } = sortState;
        filtered = [...filtered].sort((a, b) => {
          const va = a[key] ?? '';
          const vb = b[key] ?? '';
          return direction === 'asc'
            ? String(va).localeCompare(String(vb), 'zh')
            : String(vb).localeCompare(String(va), 'zh');
        });
      }
      return filtered;
    }

    function renderTable() {
      const filtered = getFilteredGames();
      const pageSize = Number(pageSizeSelect.value) || 10;
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const pageItems = filtered.slice(start, start + pageSize);

      const table = document.createElement('table');
      table.className = 'w-full text-left text-sm';

      const thead = document.createElement('thead');
      thead.innerHTML = `<tr class="border-b bg-slate-50/60">${fields.map(field => {
        const isSorted = sortState.key === field.key;
        const indicator = isSorted ? (sortState.direction === 'asc' ? 'â†‘' : 'â†“') : '';
        return `<th data-key="${field.key}" class="px-4 py-3 font-medium text-slate-600 hover:text-slate-900 cursor-pointer select-none">${field.label} ${indicator}</th>`;
      }).join('')}<th class="px-4 py-3 font-medium text-slate-600">æ“ä½œ</th></tr>`;
      thead.addEventListener('click', handleSortClick);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      if (!pageItems.length) {
        tbody.innerHTML = `<tr><td colspan="${fields.length + 1}" class="px-4 py-10 text-center text-slate-500">æš‚æ— æ•°æ®ï¼Œå¯å¯¼å…¥æˆ–æ–°å»ºæ¸¸æˆã€‚</td></tr>`;
      } else {
        tbody.innerHTML = pageItems.map(game => {
          const cells = fields.map(field => `<td class="px-4 py-3 align-top">${formatValue(game[field.key])}</td>`).join('');
          return `<tr class="border-b last:border-none hover:bg-slate-50/80">
            ${cells}
            <td class="px-4 py-3 whitespace-nowrap flex items-center gap-2">
              <button class="text-blue-600 hover:text-blue-800" data-action="edit" data-id="${game._id}">ç¼–è¾‘</button>
              <button class="text-amber-600 hover:text-amber-800" data-action="copy" data-id="${game._id}">å¤åˆ¶</button>
              <button class="text-rose-600 hover:text-rose-800" data-action="delete" data-id="${game._id}">åˆ é™¤</button>
            </td>
          </tr>`;
        }).join('');
      }
      tbody.addEventListener('click', handleRowAction);
      table.appendChild(tbody);

      tableWrap.innerHTML = '';
      tableWrap.appendChild(table);
    }

    function formatValue(value) {
      if (value === undefined || value === null || value === '') return '<span class="text-slate-400">â€”</span>';
      const str = String(value);
      if (/^https?:\/\//i.test(str)) {
        return `<a href="${str}" target="_blank" class="text-blue-600 hover:underline">${str}</a>`;
      }
      return str.replace(/\n/g, '<br />');
    }

    function handleSortClick(event) {
      const key = event.target.closest('th')?.dataset.key;
      if (!key) return;
      if (sortState.key === key) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState = { key, direction: 'asc' };
      }
      render();
    }

    function handleRowAction(event) {
      const btn = event.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const index = games.findIndex(game => game._id === id);
      if (index === -1) return;
      const game = games[index];
      if (action === 'edit') {
        openGameModal(game, index);
      } else if (action === 'copy') {
        copyGame(game);
      } else if (action === 'delete') {
        deleteGame(index);
      }
    }

    function renderPager() {
      const filtered = getFilteredGames();
      const total = filtered.length;
      const pageSize = Number(pageSizeSelect.value) || 10;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      const rangeStart = total ? (currentPage - 1) * pageSize + 1 : 0;
      const rangeEnd = Math.min(currentPage * pageSize, total);

      pagerEl.innerHTML = `
        <div>å…± <span class="font-medium">${total}</span> æ¡ï¼Œæ˜¾ç¤º ${rangeStart}-${rangeEnd}</div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1 rounded-lg border bg-white disabled:opacity-40" ${currentPage === 1 ? 'disabled' : ''} data-page="prev">ä¸Šä¸€é¡µ</button>
          <span>ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>
          <button class="px-3 py-1 rounded-lg border bg-white disabled:opacity-40" ${currentPage === totalPages ? 'disabled' : ''} data-page="next">ä¸‹ä¸€é¡µ</button>
        </div>`;
      pagerEl.querySelectorAll('button[data-page]').forEach(btn => {
        btn.addEventListener('click', () => {
          const dir = btn.dataset.page;
          if (dir === 'prev' && currentPage > 1) currentPage--;
          if (dir === 'next' && currentPage < totalPages) currentPage++;
          render();
        });
      });
    }

    function openGameModal(game = null, index = null) {
      const isEdit = Boolean(game);
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 z-50 modal-bg flex items-center justify-center p-4';

      const form = document.createElement('form');
      form.className = 'bg-white rounded-2xl shadow-xl max-w-3xl w-full p-6 space-y-4';

      const title = document.createElement('div');
      title.className = 'text-lg font-semibold';
      title.textContent = isEdit ? 'ç¼–è¾‘æ¸¸æˆ' : 'æ–°å»ºæ¸¸æˆ';
      form.appendChild(title);

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

      fields.forEach(field => {
        const wrapper = document.createElement('label');
        wrapper.className = 'flex flex-col gap-2 text-sm';
        const text = document.createElement('span');
        text.className = 'font-medium text-slate-600 flex items-center gap-1';
        text.innerHTML = field.label + (field.required ? '<span class="text-rose-500">*</span>' : '');
        wrapper.appendChild(text);

        const value = game ? (game[field.key] ?? '') : '';
        const isLongText = /desc|ç®€ä»‹|description/i.test(field.key);
        let input;
        if (isLongText) {
          input = document.createElement('textarea');
          input.rows = 4;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.className = 'w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200';
        input.name = field.key;
        input.value = value;
        if (field.required) input.required = true;
        wrapper.appendChild(input);
        grid.appendChild(wrapper);
      });
      form.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'flex items-center justify-end gap-3 pt-2';
      actions.innerHTML = `
        <button type="button" class="px-4 py-2 rounded-xl border bg-white" data-close>å–æ¶ˆ</button>
        <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">ä¿å­˜</button>`;
      form.appendChild(actions);

      overlay.appendChild(form);
      document.body.appendChild(overlay);

      overlay.addEventListener('click', e => {
        if (e.target === overlay) closeModal();
      });
      form.querySelector('[data-close]').addEventListener('click', closeModal);

      form.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(form);
        const result = { _id: game?._id || createId() };
        for (const field of fields) {
          result[field.key] = String(formData.get(field.key) || '').trim();
          if (field.required && !result[field.key]) {
            alert(`è¯·å¡«å†™ã€Œ${field.label}ã€`);
            return;
          }
        }
        if (isEdit && index !== null) {
          games.splice(index, 1, result);
        } else {
          games.unshift(result);
          currentPage = 1;
        }
        closeModal();
        render();
      });

      function closeModal() {
        overlay.remove();
      }
    }

    function copyGame(game) {
      const clone = { ...game, _id: createId(), title: game.title ? `${game.title}ï¼ˆå‰¯æœ¬ï¼‰` : '' };
      games.unshift(clone);
      currentPage = 1;
      render();
    }

    function deleteGame(index) {
      const game = games[index];
      if (!confirm(`ç¡®å®šåˆ é™¤ã€Œ${game.title || 'æœªå‘½åæ¸¸æˆ'}ã€å—ï¼Ÿ`)) return;
      games.splice(index, 1);
      render();
    }

    function openFieldManager() {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 z-50 modal-bg flex items-center justify-center p-4';
      const container = document.createElement('div');
      container.className = 'bg-white rounded-2xl shadow-xl max-w-3xl w-full p-6 space-y-4';

      const title = document.createElement('div');
      title.className = 'text-lg font-semibold';
      title.textContent = 'å­—æ®µç®¡ç†';
      container.appendChild(title);

      const description = document.createElement('p');
      description.className = 'text-sm text-slate-500';
      description.textContent = 'å¯æ‹–æ‹½æ’åºã€ç¼–è¾‘å­—æ®µåç§°ä¸é”®åï¼Œè®¾ç½®å¿…å¡«é¡¹ã€‚é”®åä¸å¯é‡å¤ï¼Œä¿å­˜åå­—æ®µç«‹å³ç”Ÿæ•ˆã€‚';
      container.appendChild(description);

      const list = document.createElement('ul');
      list.className = 'space-y-3';

      fields.forEach(field => {
        list.appendChild(createFieldRow(field));
      });
      container.appendChild(list);

      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm';
      addBtn.textContent = 'â• æ–°å¢å­—æ®µ';
      addBtn.addEventListener('click', () => {
        const newField = { key: '', label: '', required: false };
        list.appendChild(createFieldRow(newField));
      });
      container.appendChild(addBtn);

      const actions = document.createElement('div');
      actions.className = 'flex justify-end gap-3 pt-2';
      actions.innerHTML = `
        <button class="px-4 py-2 rounded-xl border bg-white" data-close>å–æ¶ˆ</button>
        <button class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700" data-save>ä¿å­˜</button>`;
      container.appendChild(actions);

      overlay.appendChild(container);
      document.body.appendChild(overlay);

      overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
      container.querySelector('[data-close]').addEventListener('click', closeModal);
      container.querySelector('[data-save]').addEventListener('click', saveFields);

      function createFieldRow(field) {
        const li = document.createElement('li');
        li.className = 'flex flex-col md:flex-row md:items-center gap-3 border rounded-xl px-4 py-3 bg-slate-50/60';
        li.draggable = true;
        li.dataset.originalKey = field.key;

        const drag = document.createElement('div');
        drag.className = 'drag-handle text-slate-400 md:w-6 flex justify-center text-lg select-none';
        drag.innerHTML = 'â˜°';
        li.appendChild(drag);

        const labelWrap = document.createElement('div');
        labelWrap.className = 'flex-1 flex flex-col gap-1';
        const labelInput = document.createElement('input');
        labelInput.type = 'text';
        labelInput.placeholder = 'æ˜¾ç¤ºåç§° (ä¾‹ï¼šæ¸¸æˆåç§°)';
        labelInput.value = field.label || '';
        labelInput.className = 'rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200';
        labelWrap.appendChild(labelInput);

        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.placeholder = 'å­—æ®µé”®å (ä¾‹ï¼štitle)';
        keyInput.value = field.key || '';
        keyInput.className = 'rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-200';
        labelWrap.appendChild(keyInput);
        li.appendChild(labelWrap);

        const requiredWrap = document.createElement('label');
        requiredWrap.className = 'inline-flex items-center gap-2 text-sm text-slate-600';
        const requiredInput = document.createElement('input');
        requiredInput.type = 'checkbox';
        requiredInput.checked = Boolean(field.required);
        requiredWrap.appendChild(requiredInput);
        requiredWrap.appendChild(document.createTextNode('å¿…å¡«'));
        li.appendChild(requiredWrap);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'text-sm text-rose-500 hover:text-rose-600';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.addEventListener('click', () => {
          if (confirm('ç¡®å®šåˆ é™¤è¯¥å­—æ®µï¼Ÿæ•°æ®ä¸ä¼šç«‹å³ä¸¢å¤±ï¼Œå¯é‡æ–°åˆ›å»ºç›¸åŒé”®åæ¢å¤ã€‚')) {
            li.remove();
          }
        });
        li.appendChild(deleteBtn);

        li.addEventListener('dragstart', () => {
          li.classList.add('opacity-60');
          dragData.dragging = li;
        });
        li.addEventListener('dragend', () => {
          li.classList.remove('opacity-60');
          dragData.dragging = null;
        });
        li.addEventListener('dragover', e => {
          e.preventDefault();
          const dragging = dragData.dragging;
          if (!dragging || dragging === li) return;
          const rect = li.getBoundingClientRect();
          const insertBefore = (e.clientY - rect.top) < rect.height / 2;
          if (insertBefore) {
            li.parentElement.insertBefore(dragging, li);
          } else {
            li.parentElement.insertBefore(dragging, li.nextSibling);
          }
        });

        li.querySelectorAll('input').forEach(input => {
          input.addEventListener('keydown', e => e.stopPropagation());
        });

        return li;
      }

      const dragData = { dragging: null };

      function saveFields() {
        const items = Array.from(list.children);
        if (!items.length) {
          alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªå­—æ®µã€‚');
          return;
        }
        const updated = [];
        const keys = new Set();
        const renameMap = new Map();
        for (const li of items) {
          const [labelInput, keyInput] = li.querySelectorAll('input[type="text"]');
          const requiredInput = li.querySelector('input[type="checkbox"]');
          const label = labelInput.value.trim();
          const key = keyInput.value.trim();
          if (!label || !key) {
            alert('å­—æ®µçš„æ˜¾ç¤ºåç§°å’Œé”®åå‡ä¸èƒ½ä¸ºç©ºã€‚');
            return;
          }
          if (/\s/.test(key)) {
            alert('é”®åä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œè¯·ä½¿ç”¨é©¼å³°æˆ–ä¸‹åˆ’çº¿å‘½åã€‚');
            return;
          }
          if (keys.has(key)) {
            alert(`å­—æ®µé”®åã€Œ${key}ã€é‡å¤ï¼Œè¯·ä¿®æ”¹ã€‚`);
            return;
          }
          keys.add(key);
          const originalKey = li.dataset.originalKey;
          if (originalKey && originalKey !== key) {
            renameMap.set(originalKey, key);
          }
          updated.push({ key, label, required: requiredInput.checked });
        }

        if (!updated.some(field => field.required)) {
          if (!confirm('å½“å‰æ²¡æœ‰å¿…å¡«å­—æ®µï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
        }

        if (renameMap.size) {
          games = games.map(game => {
            const updatedGame = { ...game };
            renameMap.forEach((newKey, oldKey) => {
              if (Object.prototype.hasOwnProperty.call(updatedGame, oldKey)) {
                updatedGame[newKey] = updatedGame[oldKey];
                delete updatedGame[oldKey];
              }
            });
            return updatedGame;
          });
        }

        fields = updated;
        closeModal();
        render();
      }

      function closeModal() {
        overlay.remove();
      }
    }

    function exportJSON() {
      const plainGames = games.map(({ _id, ...rest }) => rest);
      const data = {
        title: collectionMeta.title,
        subtitle: collectionMeta.subtitle,
        games: plainGames,
        fields,
        meta: { ...collectionMeta }
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const now = new Date();
      const filename = `game-library-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.json`;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    function handleImport(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const content = JSON.parse(e.target.result);
          let importedFields = fields;
          let importedItems = games;
          let importedMeta = collectionMeta;
          if (Array.isArray(content)) {
            importedItems = ensureIds(content);
            importedFields = buildFieldsFromItems(importedItems);
            importedMeta = { ...collectionMeta };
          } else if (content && typeof content === 'object') {
            importedFields = normaliseFields(content.fields || buildFieldsFromItems(content.items || []));
            importedItems = ensureIds(content.items || content.games || []);
            importedMeta = normaliseMeta(extractMeta(content));
          } else {
            throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
          }
          collectionMeta = importedMeta;
          fields = importedFields;
          games = importedItems;
          currentPage = 1;
          render();
          alert('å¯¼å…¥æˆåŠŸï¼');
        } catch (err) {
          console.error(err);
          alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚');
        } finally {
          event.target.value = '';
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function buildFieldsFromItems(items) {
      const keys = new Set();
      items.forEach(item => {
        Object.keys(item).forEach(key => {
          if (key === '_id') return;
          keys.add(key);
        });
      });
      if (!keys.size) return [...defaultFields];
      return Array.from(keys).map(key => ({ key, label: key, required: false }));
    }

    function resetState() {
      if (!confirm('å°†æ¸…ç©ºæœ¬åœ°ä¿å­˜çš„æ•°æ®å¹¶æ¢å¤é»˜è®¤ç¤ºä¾‹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      collectionMeta = state.meta;
      fields = state.fields;
      games = state.items;
      currentPage = 1;
      sortState = { key: null, direction: 'asc' };
      searchInput.value = '';
      pageSizeSelect.value = '10';
      render();
    }
  </script>
</body>
</html>
