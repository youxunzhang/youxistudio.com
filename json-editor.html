<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>游戏库 JSON 编辑器</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="border-b bg-white/80 backdrop-blur">
    <div class="mx-auto flex max-w-6xl flex-wrap items-center gap-3 px-4 py-4">
      <div>
        <h1 class="text-2xl font-semibold">游戏库 JSON 编辑器</h1>
        <p class="text-sm text-slate-500">直接读取 <code>data/game-library.json</code>，支持在线增删改查并导出保存。</p>
      </div>
      <div class="ml-auto flex flex-wrap gap-2 text-sm">
        <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border bg-white px-3 py-2 hover:bg-slate-50">
          <input id="fileImport" type="file" accept="application/json" class="hidden" />
          <span>📂 导入 JSON</span>
        </label>
        <button id="btnSave" class="rounded-xl border border-indigo-200 bg-indigo-500 px-3 py-2 font-medium text-white hover:bg-indigo-600">💾 保存为文件</button>
        <button id="btnCopy" class="rounded-xl border bg-white px-3 py-2 hover:bg-slate-50">📋 复制 JSON</button>
        <button id="btnReload" class="rounded-xl border bg-white px-3 py-2 hover:bg-slate-50">↩️ 重新读取原文件</button>
        <button id="btnClearLocal" class="rounded-xl border bg-white px-3 py-2 hover:bg-slate-50">🧹 清除本地缓存</button>
      </div>
    </div>
  </header>

  <main class="mx-auto flex max-w-6xl flex-col gap-6 px-4 py-6">
    <section class="rounded-2xl border bg-white p-5 shadow-sm">
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <span class="font-medium text-slate-700">当前状态：</span>
        <span id="statusMessage" class="text-slate-500">正在加载数据…</span>
      </div>
    </section>

    <section class="rounded-2xl border bg-white p-5 shadow-sm">
      <div class="mb-4 flex items-center justify-between gap-2">
        <div>
          <h2 class="text-lg font-semibold">合集元信息</h2>
          <p class="text-sm text-slate-500">这些字段会写入 JSON 顶层，用于其它页面展示。</p>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <label class="flex flex-col gap-2 text-sm">
          <span class="font-medium text-slate-700">标题（title）<span class="text-rose-500">*</span></span>
          <input id="metaTitle" type="text" class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="例如：Pop 热门速玩" />
        </label>
        <label class="flex flex-col gap-2 text-sm md:col-span-2">
          <span class="font-medium text-slate-700">副标题（subtitle）</span>
          <textarea id="metaSubtitle" rows="2" class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-200" placeholder="来自全球休闲站点的高人气小游戏…"></textarea>
        </label>
      </div>
    </section>

    <section class="rounded-2xl border bg-white p-0 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3 border-b px-5 py-4">
        <div>
          <h2 class="text-lg font-semibold">游戏列表</h2>
          <p class="text-sm text-slate-500">共 <span id="gamesCount">0</span> 条，可直接编辑表格内容。</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="btnAddGame" class="rounded-xl border border-emerald-200 bg-emerald-500 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-600">➕ 新增游戏</button>
          <button id="btnSortTitle" class="rounded-xl border bg-white px-3 py-2 text-sm hover:bg-slate-50">🔤 按名称排序</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50 text-sm text-slate-600">
            <tr>
              <th class="px-4 py-3 text-left">#</th>
              <th class="px-4 py-3 text-left">名称 (title)<span class="text-rose-500">*</span></th>
              <th class="px-4 py-3 text-left">标识 (slug)<span class="text-rose-500">*</span></th>
              <th class="px-4 py-3 text-left">链接 (url)<span class="text-rose-500">*</span></th>
              <th class="px-4 py-3 text-left">缩略图 (thumbnail)</th>
              <th class="px-4 py-3 text-left">分类 (category)</th>
              <th class="px-4 py-3 text-left">操作</th>
            </tr>
          </thead>
          <tbody id="gamesBody" class="divide-y divide-slate-100 bg-white text-sm"></tbody>
        </table>
      </div>
      <div id="emptyHint" class="hidden px-5 py-6 text-center text-sm text-slate-500">暂无数据，可点击“新增游戏”开始录入。</div>
    </section>
  </main>

  <template id="rowTemplate">
    <tr>
      <td class="align-top px-4 py-3 text-slate-500"></td>
      <td class="align-top px-4 py-3"></td>
      <td class="align-top px-4 py-3"></td>
      <td class="align-top px-4 py-3"></td>
      <td class="align-top px-4 py-3"></td>
      <td class="align-top px-4 py-3"></td>
      <td class="align-top px-4 py-3"></td>
    </tr>
  </template>

  <script>
    const STORAGE_KEY = 'game-library-editor:v1';
    const defaultData = {
      title: 'Pop 热门速玩',
      subtitle: '来自全球休闲站点的高人气小游戏，点击缩略图即可马上开玩。',
      games: [
        { title: 'Bubble Shooter Pop', slug: 'bubble-shooter-pop', url: 'https://www.crazygames.com/game/bubble-shooter-pop', thumbnail: 'img-portal/bubbleshooterpop.jpg', category: 'Puzzle' },
        { title: 'Emoji Match 3D', slug: 'emoji-match-3d', url: 'https://www.crazygames.com/game/emoji-match-3d', thumbnail: 'img-portal/emojimatch.jpeg', category: 'Brain' },
        { title: 'Match Find 3D', slug: 'match-find-3d', url: 'https://www.crazygames.com/game/match-find-3d', thumbnail: 'img-portal/matchfind3d.jpg', category: 'Puzzle' },
        { title: 'Farm Block Puzzle', slug: 'farm-block-puzzle', url: 'https://www.crazygames.com/game/farm-block-puzzle', thumbnail: 'img-portal/farmblockpuzzle.jpg', category: 'Casual' },
        { title: 'Block Puzzle 3D', slug: 'block-puzzle-3d', url: 'https://www.crazygames.com/game/block-puzzle-3d', thumbnail: 'img-portal/blockpuzzle3d.jpg', category: 'Puzzle' },
        { title: 'Block Dropping Merge', slug: 'block-dropping-merge', url: 'https://www.crazygames.com/game/blocks-merge-3d', thumbnail: 'img-portal/blockdroppingmerge.jpg', category: 'Hypercasual' },
        { title: 'Paper.io 2', slug: 'paper-io-2', url: 'https://paper-io.com/', thumbnail: 'img-portal/Paper.jpg', category: 'Arcade' },
        { title: 'Getting Over It', slug: 'getting-over-it', url: 'https://www.crazygames.com/game/getting-over-it', thumbnail: 'img-portal/gettingoverIt.jpeg', category: 'Action' },
        { title: 'Crazy Motorcycle', slug: 'crazy-motorcycle', url: 'https://www.crazygames.com/game/moto-maniac-3', thumbnail: 'img-portal/crazymotorcycle.jpg', category: 'Racing' },
        { title: 'Hawaii Match 5', slug: 'hawaii-match-5', url: 'https://www.crazygames.com/game/hawaii-match-3', thumbnail: 'img-portal/hawaiimatch5.jpg', category: 'Match' },
        { title: 'My Little City', slug: 'my-little-city', url: 'https://www.crazygames.com/game/my-little-city', thumbnail: 'img-portal/mylittlecity.jpg', category: 'Strategy' },
        { title: 'Parking Fury 3D: Night Thief', slug: 'parking-fury-3d-night-thief', url: 'https://www.crazygames.com/game/parking-fury-3d-night-thief', thumbnail: 'img-portal/parkingfury3dn.jpg', category: 'Driving' },
        { title: 'Sudoku Classic', slug: 'sudoku-classic', url: 'https://sudoku.com/', thumbnail: 'img-portal/suduku.png', category: 'Numbers' },
        { title: 'Fall Beans 2', slug: 'fall-beans-2', url: 'https://www.crazygames.com/game/fall-beans', thumbnail: 'img-portal/fallbean2.jpeg', category: 'Arcade' },
        { title: 'Magic Solitaire', slug: 'magic-solitaire', url: 'https://www.crazygames.com/game/magic-solitaire-world', thumbnail: 'img-portal/magicsolitaire.jpg', category: 'Card' },
        { title: 'High School Mean Girls 3', slug: 'high-school-mean-girls-3', url: 'https://www.girlsgogames.com/game/high-school-mean-girls-3', thumbnail: 'img-portal/highschoolmeangirls3.jpg', category: 'Girls' },
        { title: 'Vex 3', slug: 'vex-3', url: 'https://www.crazygames.com/game/vex-3', thumbnail: 'img-portal/vexx3m.jpg', category: 'Platform' }
      ]
    };

    const state = {
      meta: { title: '', subtitle: '' },
      games: [],
      dirty: false
    };

    const metaTitleInput = document.getElementById('metaTitle');
    const metaSubtitleInput = document.getElementById('metaSubtitle');
    const gamesBody = document.getElementById('gamesBody');
    const statusMessage = document.getElementById('statusMessage');
    const gamesCount = document.getElementById('gamesCount');
    const emptyHint = document.getElementById('emptyHint');

    const fileImport = document.getElementById('fileImport');
    const btnSave = document.getElementById('btnSave');
    const btnCopy = document.getElementById('btnCopy');
    const btnReload = document.getElementById('btnReload');
    const btnClearLocal = document.getElementById('btnClearLocal');
    const btnAddGame = document.getElementById('btnAddGame');
    const btnSortTitle = document.getElementById('btnSortTitle');

    function setStatus(message, variant = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = 'text-sm ' + (variant === 'error'
        ? 'text-rose-500'
        : variant === 'success'
          ? 'text-emerald-600'
          : variant === 'warn'
            ? 'text-amber-600'
            : 'text-slate-500');
    }

    function cloneState() {
      return {
        title: state.meta.title.trim(),
        subtitle: state.meta.subtitle.trim(),
        games: state.games.map(game => ({
          title: game.title?.trim() || '',
          slug: game.slug?.trim() || '',
          url: game.url?.trim() || '',
          thumbnail: game.thumbnail?.trim() || '',
          category: game.category?.trim() || ''
        }))
      };
    }

    function persist() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cloneState()));
      } catch (error) {
        console.warn('无法写入 localStorage', error);
      }
    }

    function setDirty(isDirty) {
      state.dirty = isDirty;
      if (isDirty) {
        setStatus('存在未保存的修改，请及时保存。', 'warn');
      }
    }

    function renderMeta() {
      metaTitleInput.value = state.meta.title;
      metaSubtitleInput.value = state.meta.subtitle;
    }

    function createFieldInput(game, key, placeholder = '') {
      const isTextarea = key === 'url' || key === 'thumbnail';
      const input = document.createElement(isTextarea ? 'textarea' : 'input');
      if (isTextarea) {
        input.rows = key === 'url' ? 2 : 1;
      }
      input.value = game[key] || '';
      input.placeholder = placeholder;
      input.className = 'w-full rounded-lg border px-2 py-1 focus:outline-none focus:ring focus:ring-indigo-200';
      input.addEventListener('input', () => {
        game[key] = input.value;
        setDirty(true);
        persist();
      });
      return input;
    }

    function createActionCell(gameIndex) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex flex-wrap gap-2 text-sm';

      const duplicateBtn = document.createElement('button');
      duplicateBtn.className = 'rounded-lg border bg-white px-2 py-1 hover:bg-slate-50';
      duplicateBtn.textContent = '🧬 复制';
      duplicateBtn.addEventListener('click', () => {
        const current = state.games[gameIndex];
        const duplicated = { ...current };
        state.games.splice(gameIndex + 1, 0, duplicated);
        setDirty(true);
        persist();
        renderGames();
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'rounded-lg border border-rose-200 bg-rose-50 px-2 py-1 text-rose-600 hover:bg-rose-100';
      deleteBtn.textContent = '🗑 删除';
      deleteBtn.addEventListener('click', () => {
        if (!confirm('确认删除该游戏吗？')) return;
        state.games.splice(gameIndex, 1);
        setDirty(true);
        persist();
        renderGames();
      });

      wrapper.appendChild(duplicateBtn);
      wrapper.appendChild(deleteBtn);
      return wrapper;
    }

    function renderGames() {
      gamesBody.innerHTML = '';
      if (state.games.length === 0) {
        emptyHint.classList.remove('hidden');
      } else {
        emptyHint.classList.add('hidden');
      }

      state.games.forEach((game, index) => {
        const rowTemplate = document.getElementById('rowTemplate');
        const tr = rowTemplate.content.firstElementChild.cloneNode(true);
        tr.children[0].textContent = index + 1;
        tr.children[1].className = 'align-top px-4 py-3';
        tr.children[1].appendChild(createFieldInput(game, 'title', 'Bubble Shooter Pop'));
        tr.children[2].className = 'align-top px-4 py-3';
        tr.children[2].appendChild(createFieldInput(game, 'slug', 'bubble-shooter-pop'));
        tr.children[3].className = 'align-top px-4 py-3';
        tr.children[3].appendChild(createFieldInput(game, 'url', 'https://example.com'));
        tr.children[4].className = 'align-top px-4 py-3';
        tr.children[4].appendChild(createFieldInput(game, 'thumbnail', 'img-portal/example.jpg'));
        tr.children[5].className = 'align-top px-4 py-3';
        tr.children[5].appendChild(createFieldInput(game, 'category', 'Puzzle'));
        tr.children[6].className = 'align-top px-4 py-3';
        tr.children[6].appendChild(createActionCell(index));
        gamesBody.appendChild(tr);
      });

      gamesCount.textContent = state.games.length;
    }

    function loadData(data, message = '已加载数据', variant = 'info', shouldPersist = true) {
      state.meta.title = data.title || '';
      state.meta.subtitle = data.subtitle || '';
      state.games = Array.isArray(data.games) ? data.games.map(item => ({ ...item })) : [];
      setDirty(false);
      renderMeta();
      renderGames();
      setStatus(message, variant);
      if (shouldPersist) {
        persist();
      }
    }

    async function fetchRemoteData() {
      try {
        const response = await fetch('data/game-library.json?cache=' + Date.now());
        if (!response.ok) {
          throw new Error(response.status + ' ' + response.statusText);
        }
        const json = await response.json();
        return { data: json, fromFallback: false };
      } catch (error) {
        console.error('读取远程 JSON 失败：', error);
        setStatus('读取 data/game-library.json 失败，已加载默认模板。', 'error');
        return { data: JSON.parse(JSON.stringify(defaultData)), fromFallback: true };
      }
    }

    async function init() {
      setStatus('正在读取 data/game-library.json…', 'info');
      const { data: remoteData, fromFallback } = await fetchRemoteData();
      const baseMessage = fromFallback
        ? '未能读取 data/game-library.json，已载入默认模板。'
        : '已载入 data/game-library.json，可开始编辑。';
      const baseVariant = fromFallback ? 'warn' : 'success';
      loadData(remoteData, baseMessage, baseVariant, false);

      let cachedState = null;
      try {
        const cached = localStorage.getItem(STORAGE_KEY);
        if (cached) {
          cachedState = JSON.parse(cached);
        }
      } catch (error) {
        console.warn('读取本地缓存失败', error);
      }

      if (cachedState) {
        const matchesRemote = JSON.stringify(cachedState) === JSON.stringify(remoteData);
        if (!matchesRemote) {
          const shouldRestore = confirm('检测到上次未导出的编辑内容，是否恢复？');
          if (shouldRestore) {
            loadData(cachedState, '已恢复上次编辑内容，请检查后保存。', 'warn');
            state.dirty = true;
            return;
          }
          localStorage.removeItem(STORAGE_KEY);
        }
      }

      persist();
    }

    metaTitleInput.addEventListener('input', () => {
      state.meta.title = metaTitleInput.value;
      setDirty(true);
      persist();
    });

    metaSubtitleInput.addEventListener('input', () => {
      state.meta.subtitle = metaSubtitleInput.value;
      setDirty(true);
      persist();
    });

    btnAddGame.addEventListener('click', () => {
      state.games.push({ title: '', slug: '', url: '', thumbnail: '', category: '' });
      setDirty(true);
      persist();
      renderGames();
    });

    btnSortTitle.addEventListener('click', () => {
      state.games.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'zh-Hans-CN'));
      setDirty(true);
      persist();
      renderGames();
    });

    fileImport.addEventListener('change', async (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        loadData(json, '已导入本地 JSON 文件。', 'success');
      } catch (error) {
        console.error('导入失败', error);
        setStatus('导入失败：文件格式错误或无法读取。', 'error');
      } finally {
        fileImport.value = '';
      }
    });

    btnReload.addEventListener('click', async () => {
      if (state.dirty && !confirm('存在未保存的修改，确定要放弃并重新读取原文件吗？')) {
        return;
      }
      const { data: remote, fromFallback } = await fetchRemoteData();
      const message = fromFallback
        ? '未能读取 data/game-library.json，已载入默认模板。'
        : '已重新读取 data/game-library.json。';
      const variant = fromFallback ? 'warn' : 'success';
      loadData(remote, message, variant);
    });

    btnClearLocal.addEventListener('click', () => {
      if (!confirm('确定清除本地缓存吗？此操作不会影响远程文件。')) return;
      localStorage.removeItem(STORAGE_KEY);
      setStatus('本地缓存已清除。', 'success');
    });

    btnSave.addEventListener('click', () => {
      if (!state.meta.title.trim()) {
        alert('请填写合集标题（title）。');
        return;
      }
      const output = cloneState();
      const jsonString = JSON.stringify(output, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'game-library.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      setDirty(false);
      persist();
      setStatus('已导出文件，请替换 data/game-library.json。', 'success');
    });

    btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(cloneState(), null, 2));
        setStatus('JSON 内容已复制到剪贴板。', 'success');
      } catch (error) {
        console.error('复制失败', error);
        setStatus('复制失败：浏览器不支持或未授权。', 'error');
      }
    });

    init();
  </script>
</body>
</html>
