<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Games Admin Â· åŠè‡ªåŠ¨é‡‡é›†/å°é¢ä¸‹è½½/åˆå¹¶åº“</title>
<style>
  :root{--bd:#e5e7eb;--txt:#0f172a;--mut:#64748b;--bg:#f8fafc}
  *{box-sizing:border-box}body{font:15px/1.6 system-ui,Segoe UI,Arial;margin:24px;background:var(--bg);color:var(--txt)}
  h1{margin:0 0 12px} .wrap{max-width:1100px;margin:0 auto}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{border:1px solid var(--bd);border-radius:10px;padding:10px 12px;background:#fff}
  input,select,textarea{width:100%}
  textarea{font:13px ui-monospace,Consolas,monospace;min-height:160px}
  button{cursor:pointer;background:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:14px}
  .label{font-size:12px;color:var(--mut);margin-bottom:6px}
  .small{font-size:12px;color:var(--mut)}
  .flex{display:flex;gap:8px;flex-wrap:wrap}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  img{width:160px;height:160px;object-fit:cover;border-radius:12px;border:1px solid var(--bd)}
  .ok{color:#16a34a}.warn{color:#ca8a04}.err{color:#dc2626}
</style>

<div class="wrap">
  <h1>ğŸ“š Games Admin Â· åŠè‡ªåŠ¨é‡‡é›† / å°é¢ä¸‹è½½ / åˆå¹¶åº“</h1>

  <div class="card">
    <div class="label">åŸºç¡€è®¾ç½®</div>
    <div class="grid">
      <div>
        <div class="label">Worker åŸºåœ°å€ï¼ˆå¿…å¡«ï¼‰</div>
        <input id="worker" placeholder="https://ä½ çš„-worker.workers.dev" />
      </div>
      <div>
        <div class="label">åœ¨çº¿åº“åœ°å€ï¼ˆ/data/games.jsonï¼‰</div>
        <input id="lib" placeholder="https://youxistudio.com/data/games.json" />
      </div>
      <div>
        <div class="label">æœ¬åœ°å°é¢ç›¸å¯¹ç›®å½•</div>
        <input id="coverBase" value="/img/covers/" />
      </div>
      <div class="flex">
        <div style="flex:1">
          <div class="label">å°é¢æ‰©å±•å</div>
          <select id="imgExt"><option>jpg</option><option>webp</option><option>png</option></select>
        </div>
        <div style="flex:2">
          <div class="label">å¹¶å‘æŠ“å–ï¼ˆæ‰¹é‡æ—¶ï¼‰</div>
          <input id="concurrency" value="4" />
        </div>
      </div>
    </div>
    <div class="small" style="margin-top:6px">æç¤ºï¼šç¡®ä¿ Worker å·²å®ç° <code>GET /?url=</code> ä¸ <code>GET /cache-image?src=&id=&ext=</code> ä¸¤ä¸ªç«¯ç‚¹ã€‚</div>
  </div>

  <div class="card">
    <div class="label">å•æ¡é‡‡é›†</div>
    <div class="row">
      <input id="pageUrl" placeholder="ç²˜è´´æ¸¸æˆè¯¦æƒ…é¡µ URLï¼ˆå¦‚ crazygames/poki/y8/...ï¼‰" />
      <button id="btnFetch">æŠ“å–</button>
      <button id="btnReset">æ¸…ç©º</button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">é‡‡é›†ç»“æœï¼ˆå¯ç¼–è¾‘ï¼‰</div>
        <div class="grid">
          <div>
            <div class="label">provider</div>
            <input id="provider" placeholder="crazygames / gamedistribution / poki / y8 / generic" />
          </div>
          <div>
            <div class="label">idï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¯æ”¹ï¼‰</div>
            <input id="gid" placeholder="cg-xxxxxxx" />
          </div>
        </div>

        <div class="label" style="margin-top:8px">title</div>
        <input id="title" />

        <div class="label" style="margin-top:8px">description</div>
        <textarea id="desc"></textarea>

        <div class="label" style="margin-top:8px">sourceUrl</div>
        <input id="sourceUrl" />

        <div class="grid" style="margin-top:8px">
          <div>
            <div class="label">å¤–é“¾å°é¢ï¼ˆæŠ“å–è¿”å›ï¼‰</div>
            <input id="coverRemote" placeholder="https://..." />
          </div>
          <div>
            <div class="label">æœ¬åœ°å°é¢ï¼ˆå°†å†™å…¥ JSONï¼‰</div>
            <input id="coverLocal" placeholder="/img/covers/{id}.jpg" />
          </div>
        </div>

        <div class="actions">
          <button id="btnDlCover">â¬‡ï¸ ä¸‹è½½å°é¢ï¼ˆæ–‡ä»¶åè‡ªåŠ¨å¯¹é½ï¼‰</button>
          <button id="btnUseLocal">ğŸ–¼ï¸ è®¾ç½®æœ¬åœ°å°é¢è·¯å¾„</button>
        </div>
      </div>

      <div>
        <div class="label">JSON é¢„è§ˆï¼ˆä¼šç”¨äºåˆå¹¶ï¼‰</div>
        <textarea id="jsonBox"></textarea>
        <div class="actions">
          <button id="btnMerge">ğŸ’¾ åˆå¹¶å¹¶ä¸‹è½½æ–°çš„ games.json</button>
          <button id="btnDedupe">ğŸ§¹ ä»…å»é‡å¹¶ä¸‹è½½</button>
        </div>
        <div class="small" style="margin-top:6px">åˆå¹¶è§„åˆ™ï¼šä¼˜å…ˆä»¥ <code>id</code>ã€æ¬¡ä»¥ <code>sourceUrl</code> å»é‡ï¼›æ›´æ–°æ—¶é—´æˆ³ã€‚</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="label">æ‰¹é‡ï¼ˆå¯é€‰ï¼‰â€” æ¯è¡Œä¸€ä¸ª URL</div>
    <textarea id="bulkInput" placeholder="https://www.crazygames.com/game/xxx
https://poki.com/en/g/yyy
https://www.y8.com/games/zzz"></textarea>
    <div class="actions">
      <button id="btnBulk">ğŸš€ æ‰¹é‡æŠ“å–â†’åˆå¹¶â†’ä¸‹è½½ games.json</button>
    </div>
  </div>

  <pre id="log" class="card" style="white-space:pre-wrap"></pre>
</div>

<script>
const $ = s => document.querySelector(s);
const nowISO = () => new Date().toISOString();
const clean = s => (s||'').toString().replace(/\s+/g,' ').trim();
const sleep = ms => new Promise(r=>setTimeout(r, ms));

// ç®€å•å‰ç¼€æ¨æ–­
function providerPrefix(u=''){
  const url = (u||'').toLowerCase();
  if (url.includes('crazygames.com')) return 'cg';
  if (url.includes('gamedistribution.com')) return 'gd';
  if (url.includes('poki.com')) return 'pk';
  if (url.includes('y8.com')) return 'y8';
  return 'gen';
}

// æµè§ˆå™¨ SHA-1
async function sha1hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-1', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

function log(msg, cls=''){ const el=$('#log'); el.innerHTML += (cls?`<span class="${cls}">`:'') + msg + (cls?'</span>':'') + '\n'; el.scrollTop = el.scrollHeight; }
function setJSON(obj){ $('#jsonBox').value = JSON.stringify(obj, null, 2); }
function getJSON(){ try{ return JSON.parse($('#jsonBox').value || '{}') }catch{ return null } }

async function fetchOne(pageUrl){
  const worker = clean($('#worker').value);
  if (!worker) { log('âŒ è¯·å…ˆå¡«å†™ Worker åŸºåœ°å€','err'); return null; }
  const u = `${worker}/?url=${encodeURIComponent(pageUrl)}`;
  const r = await fetch(u);
  if (!r.ok){ log(`âŒ æŠ“å–å¤±è´¥ ${r.status} ${pageUrl}`,'err'); return null; }
  const d = await r.json();
  // ç»„è£…æœ€å°å­—æ®µ
  const prov = d.provider || providerPrefix(pageUrl);
  const prefix = providerPrefix(pageUrl);
  const hash8 = (await sha1hex(d.sourceUrl || pageUrl)).slice(0,8);
  const id = `${prefix}-${hash8}`;
  const ext = clean($('#imgExt').value || 'jpg').toLowerCase();
  const obj = {
    id,
    provider: prov,
    sourceUrl: d.sourceUrl || pageUrl,
    title: clean(d.title),
    description: clean(d.description),
    cover: d.cover || '',
    createdAt: nowISO(),
    updatedAt: nowISO(),
  };
  // å›å¡« UI
  $('#provider').value = obj.provider;
  $('#gid').value = obj.id;
  $('#title').value = obj.title || '';
  $('#desc').value = obj.description || '';
  $('#sourceUrl').value = obj.sourceUrl || '';
  $('#coverRemote').value = d.cover || '';
  $('#coverLocal').value = (clean($('#coverBase').value)||'/img/covers/') + `${obj.id}.${ext}`;
  setJSON(obj);
  log(`âœ… æŠ“å–æˆåŠŸï¼š${obj.id}  ${obj.title||''}`, 'ok');
  return obj;
}

function toLocalCoverPath(id){
  const base = clean($('#coverBase').value) || '/img/covers/';
  const ext = clean($('#imgExt').value || 'jpg').toLowerCase();
  return base.replace(/\/+$/,'/') + `${id}.${ext}`;
}

async function downloadCover(single){
  const worker = clean($('#worker').value);
  const ext = clean($('#imgExt').value || 'jpg').toLowerCase();
  if(!worker){ log('âŒ Worker æœªè®¾ç½®','err'); return; }
  if(!single.cover){ log('âŒ é‡‡é›†ç»“æœç¼ºå°‘å¤–é“¾å°é¢ cover','err'); return; }
  const url = `${worker}/cache-image?src=${encodeURIComponent(single.cover)}&id=${encodeURIComponent(single.id)}&ext=${encodeURIComponent(ext)}`;
  window.open(url, '_blank'); // ç›´æ¥è§¦å‘ä¸‹è½½
  log(`â¬‡ï¸ å·²è§¦å‘å°é¢ä¸‹è½½ï¼š${single.id}.${ext}`);
}

async function loadLibrary(){
  const lib = clean($('#lib').value);
  if(!lib){ log('âš ï¸ åœ¨çº¿åº“åœ°å€ä¸ºç©ºï¼Œä½¿ç”¨ç©ºåº“','warn'); return {version:2,updatedAt:nowISO(),games:[]} }
  try{
    const r = await fetch(lib, {cache:'no-store'});
    if (!r.ok) throw new Error(r.status);
    const j = await r.json();
    j.version = j.version || 2;
    j.updatedAt = nowISO();
    j.games = Array.isArray(j.games) ? j.games : [];
    log(`ğŸ“– å·²åŠ è½½åœ¨çº¿åº“ï¼š${j.games.length} æ¡`);
    return j;
  }catch(e){
    log('âš ï¸ è¯»å–åœ¨çº¿åº“å¤±è´¥ï¼Œä½¿ç”¨ç©ºåº“','warn');
    return {version:2,updatedAt:nowISO(),games:[]};
  }
}

function dedupePush(arr, obj){
  const byId = new Map(arr.map(x=>[x.id,1]));
  const bySrc = new Map(arr.map(x=>[(x.sourceUrl||'').toLowerCase(),1]));
  if (obj.id && byId.has(obj.id)) {
    // æ›¿æ¢æ›´æ–°ï¼ˆä»¥ id ä¸ºä¸»ï¼‰
    const i = arr.findIndex(x=>x.id===obj.id);
    arr[i] = {...arr[i], ...obj, updatedAt: nowISO()};
    return;
  }
  if (obj.sourceUrl && bySrc.has(obj.sourceUrl.toLowerCase())) {
    const i = arr.findIndex(x=>(x.sourceUrl||'').toLowerCase()===obj.sourceUrl.toLowerCase());
    arr[i] = {...arr[i], ...obj, updatedAt: nowISO()};
    return;
  }
  arr.push(obj);
}

function downloadFile(name, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
  a.download = name;
  a.click(); URL.revokeObjectURL(a.href);
}

$('#btnFetch').onclick = async ()=>{
  const u = clean($('#pageUrl').value);
  if (!u) { log('âŒ è¯·è¾“å…¥æ¸¸æˆè¯¦æƒ…é¡µ URL','err'); return; }
  await fetchOne(u);
};

$('#btnReset').onclick = ()=>{
  ['provider','gid','title','desc','sourceUrl','coverRemote','coverLocal','jsonBox','pageUrl'].forEach(id=>{$('#'+id).value='';});
  log('ğŸ§½ å·²æ¸…ç©ºè¡¨å•');
};

$('#btnDlCover').onclick = async ()=>{
  const obj = getJSON();
  if(!obj){ log('âŒ JSON æ— æ•ˆ','err'); return; }
  await downloadCover(obj);
};

$('#btnUseLocal').onclick = ()=>{
  const obj = getJSON(); if(!obj){ log('âŒ JSON æ— æ•ˆ','err'); return; }
  const id = clean($('#gid').value)||obj.id;
  const lp = toLocalCoverPath(id);
  $('#coverLocal').value = lp;
  obj.id = id;
  obj.cover = lp;
  setJSON(obj);
  log(`ğŸ–¼ï¸ å·²è®¾ç½®æœ¬åœ°å°é¢è·¯å¾„ï¼š${lp}`, 'ok');
};

$('#btnMerge').onclick = async ()=>{
  const obj = getJSON();
  if(!obj){ log('âŒ JSON æ— æ•ˆ','err'); return; }
  // åŒæ­¥è¡¨å•å¯èƒ½çš„ä¿®æ”¹
  obj.provider = clean($('#provider').value) || obj.provider;
  obj.id = clean($('#gid').value) || obj.id;
  obj.title = clean($('#title').value) || obj.title;
  obj.description = clean($('#desc').value) || obj.description;
  obj.sourceUrl = clean($('#sourceUrl').value) || obj.sourceUrl;
  obj.cover = clean($('#coverLocal').value) || obj.cover || clean($('#coverRemote').value);
  obj.updatedAt = nowISO();
  if(!obj.id && obj.sourceUrl) {
    const prefix = providerPrefix(obj.sourceUrl);
    obj.id = `${prefix}-${(await sha1hex(obj.sourceUrl)).slice(0,8)}`;
  }
  const lib = await loadLibrary();
  dedupePush(lib.games, obj);
  lib.updatedAt = nowISO();
  const text = JSON.stringify(lib, null, 2);
  downloadFile('games.json', text);
  log(`ğŸ’¾ å·²åˆå¹¶å¹¶ä¸‹è½½æ–°çš„ games.jsonï¼ˆå…± ${lib.games.length} æ¡ï¼‰`, 'ok');
};

$('#btnDedupe').onclick = async ()=>{
  const lib = await loadLibrary();
  // ç®€å•å»é‡ï¼šä¼˜å…ˆ idï¼Œå† sourceUrl
  const seenId=new Set(), seenSrc=new Set(), out=[];
  for(const g of lib.games){
    if(g.id && seenId.has(g.id)) continue;
    const s=(g.sourceUrl||'').toLowerCase();
    if(s && seenSrc.has(s)) continue;
    if(g.id) seenId.add(g.id);
    if(s) seenSrc.add(s);
    out.push(g);
  }
  lib.games = out;
  lib.updatedAt = nowISO();
  const text = JSON.stringify(lib, null, 2);
  downloadFile('games.json', text);
  log(`ğŸ§¹ å·²å»é‡å¹¶ä¸‹è½½ï¼ˆå‰© ${lib.games.length} æ¡ï¼‰`, 'ok');
};

// â€”â€” æ‰¹é‡ â€”â€” //
async function pLimit(list, limit, worker){
  const ret = []; let i=0; const running = new Set();
  async function runOne(item){
    const p = Promise.resolve().then(()=>worker(item)).then(v=>ret.push(v)).finally(()=>running.delete(p));
    running.add(p);
    if(running.size >= limit) await Promise.race(running);
  }
  for(const it of list){ await runOne(it); }
  await Promise.allSettled(running);
  return ret;
}
$('#btnBulk').onclick = async ()=>{
  const lines = $('#bulkInput').value.split(/\r?\n/).map(s=>clean(s)).filter(Boolean);
  if(!lines.length){ log('âŒ æ²¡æœ‰å¯æŠ“å–çš„ URL','err'); return; }
  const lib = await loadLibrary();
  const limit = Math.max(1, Math.min(8, parseInt($('#concurrency').value || '4', 10)));
  log(`ğŸš€ æ‰¹é‡å¼€å§‹ï¼Œå…± ${lines.length} æ¡ï¼Œå¹¶å‘ ${limit}`);
  let ok=0, fail=0;
  await pLimit(lines, limit, async (u)=>{
    try{
      const one = await fetchOne(u);
      if(!one) { fail++; return; }
      // è‡ªåŠ¨æ”¹ä¸ºæœ¬åœ°å°é¢è·¯å¾„ï¼ˆå¯å…ˆä¸ä¸‹è½½ï¼‰
      one.cover = toLocalCoverPath(one.id);
      dedupePush(lib.games, one);
      ok++;
      await sleep(120); // è½»å¾®èŠ‚æµ
    }catch{ fail++; }
  });
  lib.updatedAt = nowISO();
  const text = JSON.stringify(lib, null, 2);
  downloadFile('games.json', text);
  log(`âœ… æ‰¹é‡å®Œæˆï¼šæˆåŠŸ ${ok}ï¼Œå¤±è´¥ ${fail}ã€‚å·²ä¸‹è½½æ–°çš„ games.jsonï¼ˆå…± ${lib.games.length} æ¡ï¼‰`, 'ok');
};

// é»˜è®¤å€¼ï¼ˆå¯æ”¹æˆä½ çš„ï¼‰
$('#worker').value = 'https://throbbing-frost-ec92.youxun2023.workers.dev';
$('#lib').value = 'https://youxistudio.com/data/games.json';
</script>
</html>
